<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Garden | Curated Thoughts</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNyFkW_G7FpmjRgGtdAzcFvmF5gZLaDgM",
            authDomain: "digital-garden-f4ac9.firebaseapp.com",
            projectId: "digital-garden-f4ac9",
            storageBucket: "digital-garden-f4ac9.firebasestorage.app",
            messagingSenderId: "423501957168",
            appId: "1:423501957168:web:d27abd7992a8a5d93085f5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';
        const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');

        // AUTH: Only run if we have a token (Admin). Otherwise, read as Public.
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
            } catch (e) { console.warn("Auth failed:", e); } 
            finally { loadGarden(); }
        }

        async function loadGarden() {
            const featuredContainer = document.getElementById('featured-container');
            const pillarsContainer = document.getElementById('pillars-container');
            const streamContainer = document.getElementById('stream-container');
            
            streamContainer.innerHTML = '<div class="mono" style="padding:2rem; text-align:center; opacity:0.5;">Loading garden...</div>';

            try {
                const q = query(postsCol, orderBy("date", "desc"), limit(50));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    streamContainer.innerHTML = '<div class="mono" style="padding:2rem; text-align:center;">Garden is empty. Seed some content in Admin.</div>';
                    return;
                }

                featuredContainer.innerHTML = '';
                pillarsContainer.innerHTML = '';
                streamContainer.innerHTML = '';

                let featuredFound = false;
                let pillarCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;

                    if (data.isFeatured && !featuredFound) {
                        renderFeatured(data, id, featuredContainer);
                        featuredFound = true;
                        return; 
                    }
                    if (data.isPillar && pillarCount < 4) {
                        renderPillar(data, id, pillarCount, pillarsContainer);
                        pillarCount++;
                        return; 
                    }
                    if (!data.isFeatured && !data.isPillar) {
                        renderStreamItem(data, id, streamContainer);
                    }
                });

                if (pillarCount === 0) pillarsContainer.innerHTML = '<div class="pillar-card"><div class="pillar-desc" style="opacity:0.4">No pillars defined. Check "Is Pillar" in Admin.</div></div>';
                if (!featuredFound) featuredContainer.innerHTML = '<div class="mono" style="opacity:0.5; padding:2rem;">No featured essay selected.</div>';

            } catch (err) {
                console.error("Data load error:", err);
                streamContainer.innerHTML = `<div class="mono" style="color:red;">Error: ${err.message}</div>`;
            }
        }

        function renderFeatured(data, id, container) {
            const fileUrl = data.attachmentUrl || data.imageUrl;
            const fileType = data.attachmentType || "";
            const isImage = fileUrl && (fileType.startsWith('image/') || fileUrl.match(/\.(jpeg|jpg|gif|png)$/i));

            let visualHTML = `
                <div class="abstract-art">
                    <div class="geo-shape geo-circle"></div>
                    <div class="geo-shape geo-line"></div>
                    <div class="geo-shape geo-rect"></div>
                </div>
            `;

            if (isImage) {
                visualHTML = `<div class="abstract-art" style="border:none;"><img src="${fileUrl}" style="width:100%; height:100%; object-fit:cover; border:1px solid var(--ink);" alt="Featured"></div>`;
            }

            container.innerHTML = `
                <div class="featured-grid">
                    ${visualHTML}
                    <div class="featured-content">
                        <h2>${data.title}</h2>
                        <p style="font-family: var(--font-serif); font-size: 1.2rem; opacity: 0.8; margin-bottom: 2rem;">
                            ${data.intro || 'Click to read full essay.'}
                        </p>
                        <a href="article.html?id=${id}" class="cta-button">Read Essay -></a>
                    </div>
                </div>
            `;
            
            if(!isImage && window.observer && document.querySelector('.abstract-art')) {
                window.observer.observe(document.querySelector('.abstract-art'));
            }
        }

        function renderPillar(data, id, index, container) {
            const num = String(index + 1).padStart(2, '0');
            container.insertAdjacentHTML('beforeend', `
                <a href="article.html?id=${id}" class="pillar-card">
                    <div><span class="pillar-num">${num}</span><div class="pillar-title">${data.title}</div></div>
                    <div class="pillar-desc">${data.intro || 'View this collection.'}</div>
                </a>
            `);
        }

        function renderStreamItem(data, id, container) {
            const dateStr = new Date(data.date).toLocaleDateString('en-US', { month: 'short', day: '2-digit' }).toUpperCase();
            container.insertAdjacentHTML('beforeend', `
                <article class="stream-item" onclick="window.location.href='article.html?id=${id}'">
                    <span class="mono">${dateStr}</span>
                    <h3 class="stream-title">${data.title}</h3>
                    <span class="mono stream-tag">${data.tag || '#NOTE'}</span>
                </article>
            `);
        }

        window.addEventListener('DOMContentLoaded', initAuth);
    </script>

    <style>
        :root { --paper: #F4F4F0; --ink: #1A1A1A; --font-serif: 'Playfair Display', serif; --font-sans: 'Inter', sans-serif; --font-mono: 'JetBrains Mono', monospace; --spacing-md: 2rem; --spacing-lg: 4rem; --spacing-xl: 8rem; --border-width: 1px; }
        body { background-color: var(--paper); color: var(--ink); font-family: var(--font-sans); line-height: 1.6; margin: 0; padding: 0; }
        a { color: inherit; text-decoration: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 var(--spacing-md); }
        .section-padding { padding: var(--spacing-xl) 0; }
        .border-top { border-top: 1px solid var(--ink); } .border-bottom { border-bottom: 1px solid var(--ink); }
        
        .noise-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 9999; opacity: 0.4; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); mix-blend-mode: overlay; }
        
        nav { display: flex; justify-content: space-between; padding: var(--spacing-md) 0; font-family: var(--font-mono); font-size: 0.85rem; }
        .hero { min-height: 70vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .display-text { font-size: clamp(3.5rem, 10vw, 8rem); line-height: 0.9; font-family: var(--font-serif); }
        .hero-subtitle { margin-top: var(--spacing-md); font-family: var(--font-mono); letter-spacing: 0.1em; font-size: 0.9rem; }
        
        .featured-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); align-items: center; }
        .abstract-art { aspect-ratio: 1/1; border: 1px solid var(--ink); position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .geo-shape { position: absolute; border: 1px solid var(--ink); transition: 0.5s; }
        .geo-circle { width: 60%; height: 60%; border-radius: 50%; }
        .geo-line { width: 120%; height: 1px; background: var(--ink); transform: rotate(45deg); }
        .geo-rect { width: 40%; height: 40%; top: 20%; left: 20%; }
        .featured-content h2 { font-family: var(--font-serif); font-size: clamp(2rem, 5vw, 4rem); margin-bottom: var(--spacing-md); line-height: 1.1; }
        
        .cta-button { border: 1px solid var(--ink); padding: 1rem 2rem; font-family: var(--font-mono); text-transform: uppercase; font-size: 0.8rem; display: inline-block; transition: 0.3s; }
        .cta-button:hover { background: var(--ink); color: var(--paper); }
        
        .stream-item { display: grid; grid-template-columns: 1fr 3fr 1fr; padding: var(--spacing-md) 0; border-bottom: 1px solid var(--ink); cursor: pointer; align-items: baseline; }
        .stream-item:hover { background: rgba(0,0,0,0.03); }
        .stream-title { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 500; }
        .mono { font-family: var(--font-mono); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        
        .pillars-grid { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--ink); border-left: 1px solid var(--ink); }
        .pillar-card { border-right: 1px solid var(--ink); border-bottom: 1px solid var(--ink); padding: var(--spacing-lg); min-height: 300px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.4s; }
        .pillar-card:hover { background: var(--ink); color: var(--paper); }
        .pillar-num { font-family: var(--font-serif); font-size: 3rem; }
        .pillar-title { font-family: var(--font-mono); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 0.5rem; }
        .pillar-desc { font-size: 0.9rem; opacity: 0.8; }

        .resources-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg); }
        .resource-col h3 { font-family: var(--font-mono); font-size: 0.8rem; opacity: 0.5; margin-bottom: var(--spacing-md); }
        .resource-list { list-style: none; }
        .resource-list li { margin-bottom: 0.5rem; font-family: var(--font-mono); font-size: 0.85rem; border-bottom: 1px solid transparent; padding-bottom: 2px; }
        .resource-list li:hover { border-bottom: 1px solid var(--ink); }
        
        .footer-input-wrapper { position: relative; margin-top: var(--spacing-md); }
        .email-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--ink); font-family: var(--font-serif); font-size: clamp(1.5rem, 4vw, 3rem); padding: 1rem 0; outline: none; }
        .submit-arrow { position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 2rem; cursor: pointer; }
        .footer-meta { display: flex; justify-content: space-between; margin-top: var(--spacing-xl); font-family: var(--font-mono); font-size: 0.75rem; opacity: 0.6; }

        @media (max-width: 768px) {
            .featured-grid, .pillars-grid { grid-template-columns: 1fr; }
            .stream-item { grid-template-columns: auto 1fr; gap: 1rem; }
            .stream-item .mono:last-child { display: none; }
            .pillar-card { border-right: none; }
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    <div class="container">
        <nav><div class="logo">DG — 2025</div><div class="links"><a href="about.html" style="margin-right: 20px;">[ABOUT]</a><a href="#index">[INDEX]</a></div></nav>
        <header class="hero"><h1 class="display-text">DIGITAL<br>GARDEN</h1><div class="hero-subtitle">Curated Thoughts & Archived Knowledge</div></header>
        
        <section class="section-padding border-top">
            <div class="mono" style="margin-bottom: var(--spacing-md);">01 — FEATURED ESSAY</div>
            <div id="featured-container"></div>
        </section>

        <section class="section-padding" id="index">
            <div class="mono" style="margin-bottom: var(--spacing-md);">02 — THE STREAM</div>
            <div class="border-top" id="stream-container"></div>
            <div style="text-align: center; margin-top: var(--spacing-md);"><a href="#" class="cta-button">View All Entries</a></div>
        </section>

        <section class="section-padding">
            <div class="mono" style="margin-bottom: var(--spacing-md);">03 — PILLARS</div>
            <div class="pillars-grid" id="pillars-container"></div>
        </section>

        <section class="section-padding border-bottom">
            <div class="mono" style="margin-bottom: var(--spacing-md);">04 — THE STASH</div>
            <div class="resources-grid">
                <div class="resource-col"><h3>Reading</h3><ul class="resource-list"><li><a href="#">The Design of Everyday Things <span>↗</span></a></li><li><a href="#">Grid Systems <span>↗</span></a></li></ul></div>
                <div class="resource-col"><h3>Tools</h3><ul class="resource-list"><li><a href="#">Figma <span>↗</span></a></li><li><a href="#">VS Code <span>↗</span></a></li></ul></div>
                <div class="resource-col"><h3>Inspiration</h3><ul class="resource-list"><li><a href="#">Awwwards <span>↗</span></a></li><li><a href="#">Siteinspire <span>↗</span></a></li></ul></div>
            </div>
        </section>

        <footer class="section-padding">
            <div class="mono">CORRESPONDENCE</div>
            <div class="footer-input-wrapper"><input type="email" class="email-input" placeholder="Enter your email..."><div class="submit-arrow">→</div></div>
            <div class="footer-meta"><div>© 2025 DIGITAL GARDEN</div><div>BUILT WITH AESTHETIC INTELLIGENCE</div></div>
        </footer>
    </div>
    <!-- PASTE MODAL SNIPPET HERE IF NEEDED -->
</body>
</html>
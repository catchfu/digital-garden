<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gardener's OS | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, deleteDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ‚ö†Ô∏è CONFIGURATION ‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "AIzaSyBNyFkW_G7FpmjRgGtdAzcFvmF5gZLaDgM",
            authDomain: "digital-garden-f4ac9.firebaseapp.com",
            projectId: "digital-garden-f4ac9",
            storageBucket: "digital-garden-f4ac9.firebasestorage.app",
            messagingSenderId: "423501957168",
            appId: "1:423501957168:web:d27abd7992a8a5d93085f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';
        
        // Refs
        const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
        let userTodosCol; 
        let userEventsCol; 
        let currentUser = null;

        // --- AUTH SETUP ---
        (async () => {
            try { await setPersistence(auth, browserLocalPersistence); } 
            catch (e) { await setPersistence(auth, inMemoryPersistence); }
        })();

        // --- HELPER: AUTO READ TIME ---
        window.updateReadTime = (textarea) => {
            const text = textarea.value;
            const wordsPerMinute = 200;
            const wordCount = text.trim().split(/\s+/).length;
            const minutes = Math.ceil(wordCount / wordsPerMinute);
            // Update the input field
            const readTimeInput = document.querySelector('input[name="readTime"]');
            if(readTimeInput) readTimeInput.value = (minutes || 1) + " MIN READ";
        };

        // --- STATE & TABS ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${tabName}`).classList.add('active');
            
            if (tabName === 'journal') loadPosts();
            if (tabName === 'tasks') loadTodos();
            if (tabName === 'plan') loadCalendar();
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userTodosCol = collection(db, 'artifacts', appId, 'users', user.uid, 'todos');
                userEventsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'events');
                
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('dashView').style.display = 'flex';
                document.getElementById('userEmailDisplay').innerText = user.email;
                
                switchTab('journal');
            } else {
                document.getElementById('loginView').style.display = 'flex';
                document.getElementById('dashView').style.display = 'none';
            }
        });

        window.handleLogin = async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
            } catch (error) { alert("Access Denied: " + error.message); }
        };
        window.handleLogout = () => signOut(auth);

        // ==========================================
        // 1. JOURNAL (POSTS) LOGIC
        // ==========================================
        let isEditingPostId = null;
        let currentAttachment = { url: "", type: "", name: "" };

        async function loadPosts() {
            const list = document.getElementById('postsList');
            list.innerHTML = '<div class="mono">Loading...</div>';
            try {
                const q = query(postsCol, orderBy("date", "desc"));
                const snapshot = await getDocs(q);
                list.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const p = doc.data();
                    let statusBadge = `<span class="badge badge-${p.visibility}">${p.visibility || 'public'}</span>`;
                    
                    const div = document.createElement('div');
                    div.className = 'item-row';
                    div.innerHTML = `
                        <div>
                            <div class="item-title">${p.title} ${statusBadge}</div>
                            <div class="mono date">${new Date(p.date).toLocaleDateString()}</div>
                        </div>
                        <div class="actions">
                            <button onclick="editPost('${doc.id}')" class="btn-icon">‚úé</button>
                            <button onclick="deletePost('${doc.id}')" class="btn-icon delete">√ó</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = `<div style="color:red;">Error loading posts. Check console.</div>`;
            }
        }

        window.savePost = async (e) => {
            e.preventDefault();
            const f = e.target;
            
            // Handle Attachment
            let attachData = { ...currentAttachment };
            const fileInput = document.getElementById('fileInput');
            const urlInput = document.getElementById('urlInput');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size < 500000) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise(r => reader.onload = r);
                    attachData = { url: reader.result, type: file.type, name: file.name };
                } else {
                    alert("File too big. Use URL."); return;
                }
            } else if (urlInput.value) {
                attachData = { url: urlInput.value, type: 'link', name: 'External Link' };
            }

            // Ensure read time is set if empty
            let finalReadTime = f.readTime.value;
            if(!finalReadTime) {
                const words = f.content.value.trim().split(/\s+/).length;
                finalReadTime = Math.ceil(words / 200) + " MIN READ";
            }

            const data = {
                title: f.title.value,
                tag: f.tag.value.toUpperCase(),
                intro: f.intro.value,
                content: f.content.value,
                date: new Date().toISOString(),
                readTime: finalReadTime,
                visibility: f.visibility.value, 
                isFeatured: f.isFeatured.checked,
                isPillar: f.isPillar.checked,
                attachmentUrl: attachData.url,
                attachmentType: attachData.type,
                attachmentName: attachData.name
            };

            try {
                if (isEditingPostId) await updateDoc(doc(postsCol, isEditingPostId), data);
                else await addDoc(postsCol, data);
                resetPostForm();
                loadPosts();
            } catch (e) { alert("Error saving: " + e.message); }
        };

        window.editPost = async (id) => {
            try {
                isEditingPostId = id;
                const dSnap = await getDoc(doc(postsCol, id));
                if (!dSnap.exists()) return;
                const d = dSnap.data();
                
                const f = document.getElementById('postForm');
                f.title.value = d.title;
                f.tag.value = d.tag;
                f.intro.value = d.intro;
                f.content.value = d.content;
                f.readTime.value = d.readTime;
                f.visibility.value = d.visibility || 'public';
                f.isFeatured.checked = d.isFeatured;
                f.isPillar.checked = d.isPillar;
                currentAttachment = { url: d.attachmentUrl, type: d.attachmentType, name: d.attachmentName };
                document.getElementById('formTitle').innerText = "EDITING";
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { console.error(e); }
        };

        window.deletePost = async (id) => {
            if(confirm("Delete?")) { await deleteDoc(doc(postsCol, id)); loadPosts(); }
        };

        window.resetPostForm = () => {
            isEditingPostId = null;
            document.getElementById('postForm').reset();
            document.getElementById('formTitle').innerText = "NEW ENTRY";
            currentAttachment = { url:"", type:"", name:"" };
        };

        // ==========================================
        // 2. TASKS (TODO) LOGIC
        // ==========================================
        async function loadTodos() {
            const list = document.getElementById('todoListUi');
            list.innerHTML = 'Loading...';
            try {
                const q = query(userTodosCol, orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<div class="mono" style="opacity:0.5; padding:1rem;">No tasks yet.</div>';
                    return;
                }
                snap.forEach(d => {
                    const t = d.data();
                    const el = document.createElement('div');
                    el.className = `todo-item ${t.done ? 'done' : ''}`;
                    el.innerHTML = `
                        <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo('${d.id}', this.checked)">
                        <div class="todo-text">
                            <div>${t.task}</div>
                            <div class="mono date">Due: ${t.dueDate || 'No Date'} ‚Ä¢ Shared: ${t.sharedWith ? t.sharedWith.length : 0}</div>
                        </div>
                        <button onclick="deleteTodo('${d.id}')" class="btn-icon delete">√ó</button>
                    `;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = `<div style="color:red; background:white; padding:1rem; border:1px solid red;"><strong>‚ö†Ô∏è Permission Error</strong><br>Update Firestore Rules.<br><small>${e.message}</small></div>`;
            }
        }

        window.addTodo = async (e) => {
            e.preventDefault();
            const form = e.target;
            const emails = form.share.value.split(',').map(s => s.trim()).filter(s => s);
            try {
                await addDoc(userTodosCol, {
                    task: form.task.value,
                    dueDate: form.date.value,
                    done: false,
                    createdAt: new Date().toISOString(),
                    ownerId: currentUser.uid,
                    sharedWith: emails 
                });
                form.reset();
                loadTodos();
            } catch (e) { alert("Error adding task: " + e.message); }
        };

        window.toggleTodo = async (id, status) => { await updateDoc(doc(userTodosCol, id), { done: status }); loadTodos(); };
        window.deleteTodo = async (id) => { if(confirm("Delete Task?")) { await deleteDoc(doc(userTodosCol, id)); loadTodos(); } };

        // ==========================================
        // 3. PLAN (CALENDAR) LOGIC
        // ==========================================
        async function loadCalendar() {
            const grid = document.getElementById('calGrid');
            grid.innerHTML = 'Loading...';
            try {
                const days = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
                let html = `<div class="cal-wrapper">`;
                const q = query(userEventsCol, orderBy("date"));
                const snap = await getDocs(q);
                const events = [];
                snap.forEach(d => events.push({id: d.id, ...d.data()}));

                days.forEach((day, index) => {
                    html += `<div class="cal-col"><div class="cal-head">${day}</div><div class="cal-body" id="day-${index}">`;
                    const dayEvents = events.filter(e => e.day === day);
                    dayEvents.forEach(ev => {
                        html += `<div class="cal-event"><div class="event-time">${ev.time || ''}</div><div>${ev.title}</div><div class="event-share">${ev.sharedWith?.length ? 'üë•' : ''}</div><div onclick="deleteEvent('${ev.id}')" class="event-del">√ó</div></div>`;
                    });
                    html += `</div></div>`;
                });
                html += `</div>`;
                grid.innerHTML = html;
            } catch (e) {
                grid.innerHTML = `<div style="color:red; background:white; padding:1rem; border:1px solid red;"><strong>‚ö†Ô∏è Permission Error</strong><br>Update Firestore Rules.<br><small>${e.message}</small></div>`;
            }
        }

        window.addEvent = async (e) => {
            e.preventDefault();
            const f = e.target;
            const emails = f.share.value.split(',').map(s => s.trim()).filter(s => s);
            try {
                await addDoc(userEventsCol, {
                    title: f.title.value,
                    day: f.day.value,
                    time: f.time.value,
                    ownerId: currentUser.uid,
                    sharedWith: emails,
                    date: new Date().toISOString() 
                });
                f.reset();
                loadCalendar();
            } catch (e) { alert("Error adding event: " + e.message); }
        };

        window.deleteEvent = async (id) => { if(confirm("Remove event?")) { await deleteDoc(doc(userEventsCol, id)); loadCalendar(); } }

        window.editPost = editPost; window.deletePost = deletePost;
    </script>

    <style>
        :root { --paper: #F4F4F0; --ink: #1A1A1A; --font-serif: 'Playfair Display', serif; --font-sans: 'Inter', sans-serif; --font-mono: 'JetBrains Mono', monospace; }
        body { background: var(--paper); color: var(--ink); font-family: var(--font-sans); margin: 0; height: 100vh; overflow: hidden; }
        
        #loginView { position: fixed; inset: 0; background: var(--paper); z-index: 100; display: flex; flex-direction:column; align-items: center; justify-content: center; }
        input, textarea, select { width: 100%; background: transparent; border: 1px solid var(--ink); padding: 0.8rem; font-family: inherit; margin-bottom: 1rem; }
        button { background: var(--ink); color: var(--paper); border: none; padding: 0.8rem 1.5rem; cursor: pointer; font-family: var(--font-mono); text-transform: uppercase; }
        
        #dashView { display: none; height: 100vh; }
        .sidebar { width: 250px; border-right: 1px solid var(--ink); display: flex; flex-direction: column; padding: 1rem; background: #EAEAE5; }
        .content { flex: 1; overflow-y: auto; padding: 2rem; max-width: 1000px; margin: 0 auto; width: 100%; }

        .nav-btn { display: block; width: 100%; text-align: left; padding: 1rem; margin-bottom: 0.5rem; background: transparent; color: var(--ink); border: 1px solid transparent; transition: 0.2s; }
        .nav-btn:hover { border-color: var(--ink); }
        .nav-btn.active { background: var(--ink); color: var(--paper); }
        .user-info { margin-top: auto; font-size: 0.7rem; font-family: var(--font-mono); opacity: 0.6; word-break: break-all; }

        label { display: block; font-family: var(--font-mono); font-size: 0.7rem; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .checkbox-group { display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.5rem; border: 1px dashed var(--ink); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
        .checkbox-wrapper input { width: auto; margin: 0; }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .item-title { font-weight: 600; }
        .mono.date { font-size: 0.7rem; opacity: 0.6; }
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; border: 1px solid currentColor; margin-left: 0.5rem; }
        .badge-public { color: green; }
        .badge-draft { color: #d6a000; }
        .badge-private { color: red; }
        
        .btn-icon { background: transparent; color: var(--ink); padding: 0.3rem; font-size: 1.1rem; }
        .delete { color: red; }

        .todo-item { display: flex; gap: 1rem; padding: 1rem; border: 1px solid var(--ink); margin-bottom: 0.5rem; align-items: center; background: white; }
        .todo-item.done { opacity: 0.5; text-decoration: line-through; }
        .todo-text { flex: 1; }
        
        .cal-wrapper { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid var(--ink); height: 600px; }
        .cal-col { border-right: 1px solid var(--ink); display: flex; flex-direction: column; }
        .cal-col:last-child { border-right: none; }
        .cal-head { padding: 0.5rem; text-align: center; background: var(--ink); color: var(--paper); font-family: var(--font-mono); font-size: 0.8rem; }
        .cal-body { flex: 1; padding: 0.5rem; overflow-y: auto; }
        .cal-event { background: #e0e0e0; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; position: relative; border-left: 3px solid var(--ink); }
        .event-time { font-family: var(--font-mono); font-size: 0.7rem; opacity: 0.7; }
        .event-del { position: absolute; top: 2px; right: 5px; cursor: pointer; color: red; font-weight: bold; }
        .share-input { border-style: dashed; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginView">
        <div style="width: 300px; text-align: center;">
            <h2 class="mono">GARDENER OS</h2>
            <form onsubmit="handleLogin(event)">
                <input type="email" name="email" placeholder="Email" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit">ENTER</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashView">
        <nav class="sidebar">
            <div class="mono" style="margin-bottom: 2rem; font-weight: bold;">GARDEN ADMIN</div>
            <button id="btn-journal" class="nav-btn active" onclick="switchTab('journal')">1. JOURNAL</button>
            <button id="btn-tasks" class="nav-btn" onclick="switchTab('tasks')">2. TASKS</button>
            <button id="btn-plan" class="nav-btn" onclick="switchTab('plan')">3. PLAN</button>
            <div class="user-info">Logged in as:<br><span id="userEmailDisplay"></span><br><br><a href="#" onclick="handleLogout()">[LOGOUT]</a></div>
        </nav>

        <main class="content">
            <!-- TAB 1: JOURNAL -->
            <div id="journal" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h2 class="mono" id="formTitle">NEW ENTRY</h2>
                    <button onclick="resetPostForm()" style="font-size:0.7rem; padding:0.5rem;">RESET FORM</button>
                </div>
                <form id="postForm" onsubmit="savePost(event)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                        <div><label>VISIBILITY</label><select name="visibility"><option value="public">PUBLIC (Visible to all)</option><option value="draft">DRAFT (Admin only)</option><option value="private">PRIVATE (Archive)</option></select></div>
                        <div class="checkbox-group" style="border:none; padding:0; margin:0; align-items:end;"><div class="checkbox-wrapper"><input type="checkbox" name="isFeatured"> Featured</div><div class="checkbox-wrapper"><input type="checkbox" name="isPillar"> Pillar</div></div>
                    </div>
                    <label>HEADLINE</label><input type="text" name="title" required>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;"><div><label>TAG</label><input type="text" name="tag"></div><div><label>READ TIME (Auto)</label><input type="text" name="readTime" readonly placeholder="Type content to calculate..."></div></div>
                    <label>ATTACHMENT (Max 500KB or URL)</label><input type="file" id="fileInput"><input type="text" id="urlInput" placeholder="OR paste external link here...">
                    <label>INTRO</label><input type="text" name="intro">
                    <label>CONTENT (MARKDOWN)</label>
                    <textarea name="content" style="min-height: 300px; font-family: 'JetBrains Mono', monospace;" required placeholder="# Title&#10;&#10;Write markdown content here..." oninput="updateReadTime(this)"></textarea>
                    <button type="submit" style="width:100%">SAVE POST</button>
                </form>
                <div style="margin-top:4rem; border-top:1px solid var(--ink); padding-top:2rem;"><div class="mono" style="margin-bottom:1rem;">ARCHIVE</div><div id="postsList"></div></div>
            </div>

            <!-- TAB 2: TASKS -->
            <div id="tasks" class="tab-content" style="display:none;">
                <h2 class="mono">SHARED TASKS</h2>
                <form onsubmit="addTodo(event)" style="background:#fff; padding:1.5rem; border:1px solid var(--ink); margin-bottom:2rem;">
                    <div style="display:grid; grid-template-columns: 3fr 1fr; gap:1rem;"><div><label>TASK</label><input type="text" name="task" required></div><div><label>DUE</label><input type="date" name="date"></div></div>
                    <label>SHARE WITH (Emails comma separated)</label><input type="text" name="share" class="share-input" placeholder="partner@email.com, editor@email.com">
                    <button type="submit">ADD TASK</button>
                </form>
                <div id="todoListUi"></div>
            </div>

            <!-- TAB 3: PLAN -->
            <div id="plan" class="tab-content" style="display:none;">
                <h2 class="mono">WEEKLY AGENDA</h2>
                <form onsubmit="addEvent(event)" style="background:#fff; padding:1.5rem; border:1px solid var(--ink); margin-bottom:2rem;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1rem;"><div><label>EVENT</label><input type="text" name="title" required></div><div><label>DAY</label><select name="day"><option value="MON">MONDAY</option><option value="TUE">TUESDAY</option><option value="WED">WEDNESDAY</option><option value="THU">THURSDAY</option><option value="FRI">FRIDAY</option><option value="SAT">SATURDAY</option><option value="SUN">SUNDAY</option></select></div><div><label>TIME</label><input type="text" name="time" placeholder="10:00 AM"></div></div>
                    <label>SHARE WITH (Emails comma separated)</label><input type="text" name="share" class="share-input" placeholder="partner@email.com"><button type="submit">ADD TO CALENDAR</button>
                </form>
                <div id="calGrid"></div>
            </div>
        </main>
    </div>
</body>
</html>